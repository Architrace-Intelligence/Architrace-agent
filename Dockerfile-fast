# syntax=docker/dockerfile:1.7

FROM eclipse-temurin:25-jre-alpine
ARG JAR_FILE=cli/build/libs/*-all.jar
RUN addgroup -S architrace && adduser -S -G architrace architrace
WORKDIR /app
COPY ${JAR_FILE} /app/architrace.jar
RUN mkdir -p /app/data /data /tmp && chown -R architrace:architrace /app /data /tmp
VOLUME ["/tmp", "/config", "/data"]
EXPOSE 8080

ENV JAVA_HEAP_DUMP_OPTS="-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp" \
    JAVA_ON_OUT_OF_MEMORY_OPTS="-XX:+ExitOnOutOfMemoryError" \
    JAVA_ERROR_FILE_OPTS="-XX:ErrorFile=/tmp/java_error.log" \
    JAVA_NATIVE_MEMORY_TRACKING_OPTS="-XX:NativeMemoryTracking=summary -XX:+UnlockDiagnosticVMOptions -XX:+PrintNMTStatistics" \
    GC_OPTS="-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseZGC" \
    JAVA_OPTS=""

USER architrace

ENTRYPOINT ["sh", "-c", "exec java $JAVA_HEAP_DUMP_OPTS $JAVA_ON_OUT_OF_MEMORY_OPTS $JAVA_ERROR_FILE_OPTS $JAVA_NATIVE_MEMORY_TRACKING_OPTS $GC_OPTS $JAVA_OPTS -jar /app/architrace.jar \"$@\"", "entrypoint"]
CMD ["run"]
