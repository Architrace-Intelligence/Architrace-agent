# syntax=docker/dockerfile:1.7

FROM ghcr.io/graalvm/native-image-community:25 AS build
WORKDIR /workspace

COPY . .

RUN chmod +x ./gradlew \
    && ./gradlew --no-daemon :agent-app:shadowJar \
    && native-image \
      --no-fallback \
      -jar agent-app/build/libs/agent-app-*-all.jar \
      architrace

FROM debian:bookworm-slim AS runtime-libs

FROM gcr.io/distroless/base-debian12:nonroot

WORKDIR /app
COPY --from=build /workspace/architrace /app/architrace
COPY --from=runtime-libs /lib/x86_64-linux-gnu/libz.so.1 /lib/x86_64-linux-gnu/libz.so.1

VOLUME ["/tmp", "/config", "/data"]
EXPOSE 8080

ENTRYPOINT ["/app/architrace"]
CMD ["run", "--config", "/config/architrace.properties"]
