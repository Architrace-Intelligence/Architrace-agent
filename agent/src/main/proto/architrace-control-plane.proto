syntax = "proto3";

package architrace.controlplane.v1;

option java_multiple_files = true;
option java_package = "io.github.architrace.grpc.proto";
option java_outer_classname = "ControlPlaneProto";

service ControlPlaneService {
  // Основной двунаправленный канал агента
  rpc Connect(stream AgentEvent) returns (stream ControlPlaneEvent);
}

// Агент → Сервер
message AgentEvent {
  string agent_id = 1;
  oneof payload {
    RegisterRequest registerRequest = 2;
    MetricsPayload  metrics  = 3;
  }
}

message RegisterRequest {
  string agent_name    = 1;
  string host          = 2;
  string version       = 3;
  map<string, string> tags = 4;
}

message MetricsPayload {
  int64 collected_at_ms        = 1;
  repeated MetricEntry entries = 2;
}

message MetricEntry {
  string name              = 1;
  double value             = 2;
  map<string, string> tags = 3;
}

// Сервер → Агент
message ControlPlaneEvent {
  oneof payload {
    RegisterResponse registerResponse    = 1;
    CommandRequest   command             = 2;
  }
}

message RegisterResponse {
  bool   accepted      = 1;
  string agent_id      = 2;  // сервер назначает ID
  int64  metrics_interval_ms = 4;
}

message CommandRequest {
  string command_id = 1;
  string type       = 2;  // RESTART, UPDATE_CONFIG, etc.
  map<string, string> params = 3;
}
